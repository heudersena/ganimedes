"use strict";var w=Object.defineProperty;var E=Object.getOwnPropertyDescriptor;var O=Object.getOwnPropertyNames;var m=Object.prototype.hasOwnProperty;var R=(i,t)=>{for(var e in t)w(i,e,{get:t[e],enumerable:!0})},h=(i,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of O(t))!m.call(i,a)&&a!==e&&w(i,a,{get:()=>t[a],enumerable:!(n=E(t,a))||n.enumerable});return i};var A=i=>h(w({},"__esModule",{value:!0}),i);var S={};R(S,{WithDrawController:()=>p});module.exports=A(S);var l=require("@prisma/client"),s=new l.PrismaClient({});s.$disconnect();var c=(i,t=!1,e="")=>({data:i,error:t,errorMessage:e});var u=class{static async index(t){let e=await this.INTERNAL_GET_ME_USER(t),n=await s.withdrawal.findMany({where:{profile_id:e==null?void 0:e.id},orderBy:{created_at:"desc"}});return c(n,!1,"")}static async getBayId(t){let e=await s.withdrawal.findFirst({where:{id:t}});return c(e,!1,"")}static async requestWithdrawal(t,e){let n=await s.profile.findUnique({where:{keycloak_id:e}}),a=await this.INTERNAL_GET_ME_USER(e),r=await s.withdrawal.findMany({where:{profile_id:a==null?void 0:a.id,AND:{status:"processing"}}});if(r.length)return c(r,!0,"VOC\xCA J\xC1 FEZ UMA SOLICITA\xC7\xC3O DE SAQUE, AGUARDE O TERMINO DESSE PROCESSO.");if(t>Number(n==null?void 0:n.balance)||(a==null?void 0:a.id)===null)return c(a,!0,"VALOR QUE VOC\xCA SOLICITOU \xC9 MAIOR QUE VOC\xCA POSSU\xCD");let o=await s.withdrawal.create({data:{amount:t,profile_id:a==null?void 0:a.id}});return c(o,!1,"SOLICITA\xC7\xC3O FOI CONCLU\xCDDA COM SUCESSO.")}static async update(t,e,n,a){let r=await this.INTERNAL_GET_ME_USER(e),o=await s.withdrawal.findFirst({where:{id:t,AND:{status:"processing"}}}),f=Number(r==null?void 0:r.balance)-Number(o==null?void 0:o.amount);if(console.log(o),n==="accepted"&&o!=null)try{let d=await s.$transaction([s.profile.update({where:{keycloak_id:e},data:{balance:f}}),s.withdrawal.update({where:{id:t},data:{status:"accepted"}})]);return c(d,!1,"ATUALIZADA COM SUCESSO")}catch(d){return c(d,!0,"Ops!")}else if(n==="refused"&&o!=null){let d=await s.withdrawal.update({where:{id:t},data:{status:"refused",description:a}});return c(d,!1,"VOC\xCA RECUSOU A SOLICITA\xC7\xC3O")}else return c([],!0,"EST\xC1 SOLICITA\xC7\xC3O N\xC3O TEVE NENHUMA A\xC7\xC3O")}static async INTERNAL_GET_ME_USER(t){return await s.profile.findUnique({where:{keycloak_id:t}})}};var p=class{static async index(t,e){let n=t.user.content.sub,a=await u.index(n);e.json(a)}static async getBayId(t,e){let n=t.params.id,a=await u.getBayId(n);e.json(a)}static async store(t,e){let n=Number(t.body.amount),a=t.user.content.sub,r=await u.requestWithdrawal(n,a);return r.error?e.status(400).json(r):e.status(200).json(r)}static async update(t,e){let n=t.user.content.sub,a=t.body.status,r=t.params.id,o=await u.update(r,n,a);e.json(o)}};0&&(module.exports={WithDrawController});
