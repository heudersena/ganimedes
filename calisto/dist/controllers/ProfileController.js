"use strict";var B=Object.create;var y=Object.defineProperty;var q=Object.getOwnPropertyDescriptor;var v=Object.getOwnPropertyNames;var Y=Object.getPrototypeOf,G=Object.prototype.hasOwnProperty;var j=(o,t)=>{for(var e in t)y(o,e,{get:t[e],enumerable:!0})},C=(o,t,e,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of v(t))!G.call(o,n)&&n!==e&&y(o,n,{get:()=>t[n],enumerable:!(a=q(t,n))||a.enumerable});return o};var P=(o,t,e)=>(e=o!=null?B(Y(o)):{},C(t||!o||!o.__esModule?y(e,"default",{value:o,enumerable:!0}):e,o)),U=o=>C(y({},"__esModule",{value:!0}),o);var X={};j(X,{ProfileController:()=>E});module.exports=U(X);var I=require("@prisma/client"),r=new I.PrismaClient({});r.$disconnect();var b=class{constructor(){this.FN_LOCAL_VERIFY_EMAIL_EXIST=async t=>!!await r.profile.findUnique({where:{email:t}});this.FN_LOCAL_VERIFY_CPF_EXIST=async t=>!!await r.profile.findUnique({where:{cpf:t}})}};var i=(o,t=!1,e="")=>({data:o,error:t,errorMessage:e});var F=P(require("gerar-cpf")),L=()=>"G-"+(0,F.default)();var g=class{static async DatabaseMethodCreation(t){try{let e=await r.accumulator_bonus.create({data:{bonus_amount:0,profile_id:t}});return i(e)}catch(e){return i([],!0,e)}}};var u=class{static async DatabaseMethodSelectAll(){try{let t=await r.profile.findMany();return i(t)}catch(t){return i([],!0,t)}}static async DatabaseMethodGetTotalBalance(t){try{let e=await r.profile.findFirst({where:{keycloak_id:t},select:{balance:!0,bonus:!0}});return i(e)}catch(e){return i([],!0,e)}}static async DatabaseMethodSelectOne(t){try{let e=await r.profile.findFirst({where:{keycloak_id:t},orderBy:{created_at:"desc"}});return i(e)}catch(e){return i([],!0,e)}}static async DatabaseMethodCreation(t){try{if(console.log("0000000000000000000000000000000000"),console.log(await this.DatabaseMethodAuxiliariesCheckExistsCPF(t.cpf)),console.log(await this.DatabaseMethodAuxiliariesCheckExistsEMAIL(t.email)),console.log("0000000000000000000000000000000000"),await this.DatabaseMethodAuxiliariesCheckExistsCPF(t.cpf)||await this.DatabaseMethodAuxiliariesCheckExistsEMAIL(t.email))return i([],!0,"EMAIL OU CPF J\xC1 EXISTE EM NOSSOS CADASTRO!");let e=await r.profile.create({data:{keycloak_id:t.keycloak_id,first_name:t.first_name,second_name:t.second_name,email:t.email,cpf:t.cpf??L(),balance:t.balance??0,bonus:t.bonus??0,phone:t.phone,type_profile:"ROLE_PLAYER",keyPix:t.keyPix,reference_code:t.reference_code??"NULL"}}),a=await g.DatabaseMethodCreation(e.id);return i({content:e,accumulator_create:a})}catch(e){return i([],!0,e)}}static async DatabaseMethodEditAdmin(t,e,a){try{let n=await r.profile.update({where:{id:t},data:{type_profile:e.roles,reference_code:a}});return i(n)}catch(n){return i([],!0,n)}}static async DatabaseMethodEditUser(t,e,a,n){try{let s=await r.profile.update({where:{keycloak_id:t},data:{phone:e,cpf:a,keyPix:n}});return i(s)}catch(s){return s}}static async DatabaseMethodAuxiliariesCheckExistsCPF(t){return t===void 0?!1:!!await r.profile.findFirst({where:{cpf:t}})}static async DatabaseMethodAuxiliariesCheckExistsEMAIL(t){return!!await r.profile.findFirst({where:{email:t}})}};var h=P(require("mercadopago")),S=P(require("dayjs"));h.default.configurations.setAccessToken(String(process.env.MERCADO_PAGO_KEY_PROD));var x=class{static async CreatePayment(t){var e;try{let a={transaction_amount:t.transaction_amount,payment_method_id:t.payment_method_id,payer:{email:t.payer.email},installments:1,date_of_expiration:String((0,S.default)(new Date).add(6,"minutes").format("YYYY-MM-DDTHH:mm:ss.000ZZ"))};return await((e=h.default.payment)==null?void 0:e.save(a))}catch(a){return a}}static async GetPayment(t){try{return await h.default.payment.findById(t)}catch(e){return e}}};var w=class{static async DatabaseMethodSelectAll(){try{let t=await r.percentage_today.findFirst();return i(Number(t==null?void 0:t.percentage))}catch(t){return i([],!0,t)}}static async DatabaseMethodCreation(t){let e=await this.DatabaseMethodAuxiliariesCheckExistsPercentage();if(e){let a=await r.percentage_today.update({where:{id:e},data:{percentage:t}});return i(a)}else{let a=await r.percentage_today.create({data:{percentage:t}});return i(a)}}static async DatabaseMethodAuxiliariesCheckExistsPercentage(){let t=await r.percentage_today.findFirst();return t==null?void 0:t.id}};var M=class{static async DatabaseMethodGetAll(t){var a;return(a=(await r.profile.findMany({where:{email:t},include:{Transaction:{include:{MercadoPago:!0},orderBy:{created_at:"desc"}}},orderBy:{created_at:"desc"}}))[0])==null?void 0:a.Transaction}static async DatabaseMethodCreation(t,e){var a,n,s,d,_,l,m,R,D,k;try{let p=await u.DatabaseMethodSelectOne(t),O=p.data.id,A=(await w.DatabaseMethodSelectAll()).data,T=e*A/100,c=await x.CreatePayment({transaction_amount:e,payment_method_id:"pix",installments:1,payer:{email:(a=p.data)==null?void 0:a.email}}),f=await r.transaction.create({data:{profile_id:O,balance:e,bonus:T,percentage_bonus:A,type_transaction:"ROLE_DEPOSIT"}}),N=await r.mercadoPago.create({data:{m_id:String((n=c.response)==null?void 0:n.id),m_action:"created",m_qr_code:(s=c.response)==null?void 0:s.point_of_interaction.transaction_data.qr_code,m_status:(d=c.response)==null?void 0:d.status,m_net_received_amount:(_=c.response)==null?void 0:_.transaction_details.net_received_amount,m_ticket_url:(l=c.response)==null?void 0:l.point_of_interaction.transaction_data.ticket_url,m_total_paid_amount:(m=c.response)==null?void 0:m.transaction_details.total_paid_amount,m_status_detail:(R=c.response)==null?void 0:R.status_detail,m_transaction_id:((D=c.response)==null?void 0:D.point_of_interaction.transaction_data.transaction_id)??"null",m_qr_code_base64:(k=c.response)==null?void 0:k.point_of_interaction.transaction_data.qr_code_base64,transaction_id:f==null?void 0:f.id}});return{transaction:f,mercado_pago:N,mp:c}}catch(p){return p}}};var gt=new b,E=class{static async me(t,e,a){let n=await u.DatabaseMethodSelectOne(t.user.content.sub);return e.json({request:t.user,user:n})}static async getTotalBalance(t,e,a){var s,d,_;let n=await u.DatabaseMethodGetTotalBalance(t.user.content.sub);return e.json({balance:Number((s=n.data)==null?void 0:s.balance),balance_br:Number((d=n.data)==null?void 0:d.balance).toLocaleString("pt-br",{style:"currency",currency:"BRL"}),bonus:Number((_=n.data)==null?void 0:_.bonus).toLocaleString("pt-br",{style:"currency",currency:"BRL"})})}static async index(t,e,a){return console.log(t.user),e.json({balance:t.user})}static async store(t,e,a){var d,_,l,m;let n={...t.body,first_name:(d=t.user)==null?void 0:d.content.given_name,second_name:(_=t.user)==null?void 0:_.content.family_name,email:(l=t.user)==null?void 0:l.content.email,keycloak_id:(m=t.user)==null?void 0:m.content.sub},s=await u.DatabaseMethodCreation(n);return e.json(s)}static async store_deposit(t,e,a){let n=Number(t.body.balance),s=await M.DatabaseMethodCreation(t.user.content.sub,n);return t.io.sockets.in(t.user.content.email).emit("new-deposit",{update:!0}),e.json(s)}static async request_withdrawal(t,e,a){var s;let n={...t.body,keycloak_id:(s=t.user)==null?void 0:s.content.sub};return e.json([])}};0&&(module.exports={ProfileController});
