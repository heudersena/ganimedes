"use strict";var l=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var f=Object.getOwnPropertyNames;var p=Object.prototype.hasOwnProperty;var A=(i,t)=>{for(var e in t)l(i,e,{get:t[e],enumerable:!0})},S=(i,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of f(t))!p.call(i,a)&&a!==e&&l(i,a,{get:()=>t[a],enumerable:!(n=O(t,a))||n.enumerable});return i};var h=i=>S(l({},"__esModule",{value:!0}),i);var U={};A(U,{WithDrawDatabase:()=>E});module.exports=h(U);var u=require("@prisma/client"),r=new u.PrismaClient({});r.$disconnect();var s=(i,t=!1,e="")=>({data:i,error:t,errorMessage:e});var E=class{static async index(t){let e=await this.INTERNAL_GET_ME_USER(t),n=await r.withdrawal.findMany({where:{profile_id:e==null?void 0:e.id},orderBy:{created_at:"desc"}});return s(n,!1,"")}static async getBayId(t){let e=await r.withdrawal.findFirst({where:{id:t}});return s(e,!1,"")}static async requestWithdrawal(t,e){let n=await r.profile.findUnique({where:{keycloak_id:e}}),a=await this.INTERNAL_GET_ME_USER(e),o=await r.withdrawal.findMany({where:{profile_id:a==null?void 0:a.id,AND:{status:"processing"}}});if(o.length)return s(o,!0,"VOC\xCA J\xC1 FEZ UMA SOLICITA\xC7\xC3O DE SAQUE, AGUARDE O TERMINO DESSE PROCESSO.");if(t>Number(n==null?void 0:n.balance)||(a==null?void 0:a.id)===null)return s(a,!0,"VALOR QUE VOC\xCA SOLICITOU \xC9 MAIOR QUE VOC\xCA POSSU\xCD");let c=await r.withdrawal.create({data:{amount:t,profile_id:a==null?void 0:a.id}});return s(c,!1,"SOLICITA\xC7\xC3O FOI CONCLU\xCDDA COM SUCESSO.")}static async update(t,e,n,a){let o=await this.INTERNAL_GET_ME_USER(e),c=await r.withdrawal.findFirst({where:{id:t,AND:{status:"processing"}}}),d=Number(o==null?void 0:o.balance)-Number(c==null?void 0:c.amount);if(console.log(c),n==="accepted"&&c!=null)try{let w=await r.$transaction([r.profile.update({where:{keycloak_id:e},data:{balance:d}}),r.withdrawal.update({where:{id:t},data:{status:"accepted"}})]);return s(w,!1,"ATUALIZADA COM SUCESSO")}catch(w){return s(w,!0,"Ops!")}else if(n==="refused"&&c!=null){let w=await r.withdrawal.update({where:{id:t},data:{status:"refused",description:a}});return s(w,!1,"VOC\xCA RECUSOU A SOLICITA\xC7\xC3O")}else return s([],!0,"EST\xC1 SOLICITA\xC7\xC3O N\xC3O TEVE NENHUMA A\xC7\xC3O")}static async INTERNAL_GET_ME_USER(t){return await r.profile.findUnique({where:{keycloak_id:t}})}};0&&(module.exports={WithDrawDatabase});
